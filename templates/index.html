<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RL4T1D Continuous Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; text-align: center; }
        .controls, .meals-section, .status, .results-info { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"], input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button {
            background-color: #5cb85c; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;
            margin-right: 10px;
        }
        button:hover { background-color: #4cae4c; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #addMealButton { background-color: #007bff; }
        #addMealButton:hover { background-color: #0056b3; }
        #finishSimButton { background-color: #d9534f; }
        #finishSimButton:hover { background-color: #c9302c; }

        .meal-entry { display: flex; align-items: center; margin-bottom: 10px; }
        .meal-entry label { margin-right: 10px; min-width: 100px; }
        .meal-entry input { flex-grow: 1; margin-right: 10px; }
        .meal-entry .remove-meal { background-color: #d9534f; font-size: 12px; padding: 5px 10px; }
        .meal-entry .remove-meal:hover { background-color: #c9302c; }
        #statusMessage { font-style: italic; color: #555; }
        #chartContainer { width: 95%; max-width: 1200px; margin: 20px auto; background-color: #fff; padding: 10px; border-radius: 5px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
        .error-message { color: red; font-weight: bold; }
        .warning-message { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <h1>T1D Reinforcement Learning - Continuous Simulation</h1>

        <div class="meals-section">
            <h2>Meal Configuration (for each simulation segment)</h2>
            <div id="mealsContainer">
                <!-- Meal entries will be added here -->
            </div>
            <button id="addMealButton">Add Meal</button>
        </div>

        <div class="controls">
            <button id="startSimButton">Start Continuous Simulation</button>
            <button id="finishSimButton" disabled>Finish Simulation</button>
        </div>

        <div class="status">
            <h2>Status</h2>
            <p id="statusMessage">Waiting for simulation to start...</p>
            <p id="patientInfo"></p>
            <p id="progressInfo"></p>
            <p class="error-message" id="errorMessage"></p>
            <p class="warning-message" id="warningMessage"></p>
        </div>
        
        <div id="chartContainer">
            <canvas id="simulationChart"></canvas>
        </div>
         <div class="results-info">
            <h2>Live Rewards (Cumulative per Agent)</h2>
            <p>PPO Total Reward: <span id="ppoTotalReward">0.00</span></p>
            <p>PCPO Total Reward: <span id="pcpoTotalReward">0.00</span></p>
        </div>
    </div>

    <script>
        const socket = io(); 

        const startSimButton = document.getElementById('startSimButton');
        const finishSimButton = document.getElementById('finishSimButton');
        const addMealButton = document.getElementById('addMealButton');
        const mealsContainer = document.getElementById('mealsContainer');
        const statusMessage = document.getElementById('statusMessage');
        const patientInfo = document.getElementById('patientInfo');
        const progressInfo = document.getElementById('progressInfo');
        const errorMessage = document.getElementById('errorMessage');
        const warningMessage = document.getElementById('warningMessage');
        const ppoTotalRewardEl = document.getElementById('ppoTotalReward');
        const pcpoTotalRewardEl = document.getElementById('pcpoTotalReward');

        let simulationChart;
        let chartData = {
            labels: [], // Global step numbers
            datasets: [
                { label: 'PPO CGM (mg/dL)', borderColor: 'rgb(0, 123, 255)', tension: 0.1, data: [], yAxisID: 'yCGM', pointRadius: 1, fill: false },
                { label: 'PCPO CGM (mg/dL)', borderColor: 'rgb(255, 193, 7)', tension: 0.1, data: [], yAxisID: 'yCGM', pointRadius: 1, fill: false },
                { label: 'PPO Insulin (U)', borderColor: 'rgb(40, 167, 69)', data: [], yAxisID: 'yInsulin', stepped: true, pointRadius: 0, fill: false },
                { label: 'PCPO Insulin (U)', borderColor: 'rgb(220, 53, 69)', data: [], yAxisID: 'yInsulin', stepped: true, pointRadius: 0, fill: false },
                { label: 'Meal (g CHO)', borderColor: 'rgb(108, 117, 125)', backgroundColor: 'rgba(108, 117, 125, 0.3)', type: 'bar', data: [], yAxisID: 'yMeal' }
            ]
        };
        let simSamplingRate = 5;
        let currentPatientName = "Unknown";
        let ppoCumulativeReward = 0;
        let pcpoCumulativeReward = 0;
        let maxChartPoints = 288 * 3; // Show approx 3 days of data, adjust as needed

        function initializeChart() {
            const ctx = document.getElementById('simulationChart').getContext('2d');
            if (simulationChart) {
                simulationChart.destroy();
            }
            chartData.labels = [];
            chartData.datasets.forEach(ds => ds.data = []);
            ppoCumulativeReward = 0;
            pcpoCumulativeReward = 0;
            updateRewardDisplay();

            simulationChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: false, // Disable for faster live updates if needed, or keep minimal
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (hours)' },
                            ticks: {
                                callback: function(value, index, values) {
                                    // 'value' is the actual label (global step number)
                                    return (chartData.labels[index] * simSamplingRate / 60).toFixed(1);
                                }
                            }
                        },
                        yCGM: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'CGM (mg/dL)' }, suggestedMin: 40, suggestedMax: 350 },
                        yInsulin: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Insulin (U)' }, suggestedMin: 0, grid: { drawOnChartArea: false } },
                        yMeal: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Meal (g CHO)' }, suggestedMin: 0, grid: { drawOnChartArea: false }, offset: true }
                    },
                    plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } }
                }
            });
        }
        
        function addMealEntry() { /* ... (same as before) ... */ 
            const mealId = Date.now();
            const mealDiv = document.createElement('div');
            mealDiv.classList.add('meal-entry');
            mealDiv.id = `meal-${mealId}`;
            mealDiv.innerHTML = `
                <label for="mealTime-${mealId}">Time (minutes into segment):</label>
                <input type="number" id="mealTime-${mealId}" name="mealTime" min="0" step="1" value="0">
                <label for="mealCarbs-${mealId}">Carbs (g):</label>
                <input type="number" id="mealCarbs-${mealId}" name="mealCarbs" min="0" step="1" value="0">
                <button class="remove-meal" data-mealid="${mealId}">X</button>
            `;
            mealsContainer.appendChild(mealDiv);
            mealDiv.querySelector('.remove-meal').addEventListener('click', function() {
                document.getElementById(`meal-${this.dataset.mealid}`).remove();
            });
        }


        function collectMealData() { /* ... (same as before) ... */
            const meals = [];
            const mealEntries = mealsContainer.querySelectorAll('.meal-entry');
            mealEntries.forEach(entry => {
                const timeInput = entry.querySelector('input[name="mealTime"]');
                const carbsInput = entry.querySelector('input[name="mealCarbs"]');
                if (timeInput && carbsInput && timeInput.value !== "" && carbsInput.value !== "") {
                    meals.push({
                        time_minutes: parseInt(timeInput.value, 10),
                        carbs: parseFloat(carbsInput.value)
                    });
                }
            });
            return meals;
        }

        function startContinuousSimulation() {
            const meals = collectMealData();
            console.log("Emitting 'start_continuous_simulation' with meals:", meals);
            
            statusMessage.textContent = "Requesting continuous simulation start...";
            errorMessage.textContent = "";
            warningMessage.textContent = "";
            patientInfo.textContent = "";
            progressInfo.textContent = "";
            startSimButton.disabled = true;
            finishSimButton.disabled = false;
            initializeChart(); // Reset chart for new run

            socket.emit('start_continuous_simulation', { meals: meals });
        }

        function finishContinuousSimulation() {
            console.log("Emitting 'stop_continuous_simulation'");
            socket.emit('stop_continuous_simulation');
            statusMessage.textContent = "Stop signal sent. Waiting for simulation to finalize...";
            finishSimButton.disabled = true; // Prevent multiple clicks
        }

        function updateRewardDisplay() {
            ppoTotalRewardEl.textContent = ppoCumulativeReward.toFixed(2);
            pcpoTotalRewardEl.textContent = pcpoCumulativeReward.toFixed(2);
        }
        
        // Socket Handlers
        socket.on('connect', () => {
            console.log("Socket connected: ", socket.id);
            statusMessage.textContent = "Connected. Ready to start.";
            startSimButton.disabled = false;
            finishSimButton.disabled = true;
        });

        socket.on('connection_ack', (data) => console.log(data.message));

        socket.on('simulation_starting_continuous', (data) => {
            console.log('Backend: Continuous simulation starting:', data);
            statusMessage.textContent = data.message;
        });
        
        socket.on('simulation_metadata', (data) => {
            console.log('Backend: Received simulation metadata:', data);
            currentPatientName = data.patient_name;
            simSamplingRate = data.sampling_rate;
            patientInfo.textContent = `Patient: ${currentPatientName}, Sampling: ${simSamplingRate} min/step. Running...`;
        });

        socket.on('simulation_data_point', (data) => {
            // console.log('Data point:', data);
            const currentGlobalStep = data.step;

            // Add X label (global step) if it's new
            if (!chartData.labels.includes(currentGlobalStep)) {
                 chartData.labels.push(currentGlobalStep);
                 // Ensure all datasets have a placeholder for this new step if data for it hasn't arrived yet
                 chartData.datasets.forEach(ds => {
                    if (ds.data.length < chartData.labels.length) {
                        ds.data.push(null); // or NaN, or handle appropriately
                    }
                 });
            }
            const labelIndex = chartData.labels.indexOf(currentGlobalStep);


            if (data.agent === 'ppo') {
                chartData.datasets[0].data[labelIndex] = data.cgm;
                chartData.datasets[2].data[labelIndex] = data.insulin;
                ppoCumulativeReward += data.reward;
                // PPO is source of truth for meal for this step
                chartData.datasets[4].data[labelIndex] = data.meal; 
            } else if (data.agent === 'pcpo') {
                chartData.datasets[1].data[labelIndex] = data.cgm;
                chartData.datasets[3].data[labelIndex] = data.insulin;
                pcpoCumulativeReward += data.reward;
                // If PPO didn't provide meal data for this step, PCPO can
                if(chartData.datasets[4].data[labelIndex] == null || chartData.datasets[4].data[labelIndex] === 0) {
                     chartData.datasets[4].data[labelIndex] = data.meal;
                }
            }
            
            // Keep chart from growing indefinitely large
            if (chartData.labels.length > maxChartPoints) {
                chartData.labels.shift();
                chartData.datasets.forEach(ds => ds.data.shift());
            }

            simulationChart.update();
            updateRewardDisplay();
            progressInfo.textContent = `Current global step: ${currentGlobalStep}`;
        });

        socket.on('segment_complete', (data) => {
            console.log(`Backend: Segment ${data.segment_number} complete.`);
            statusMessage.textContent = `Segment ${data.segment_number} complete. Starting next...`;
        });
        
        socket.on('simulation_finished', (data) => {
            console.log('Backend: Simulation finished.', data.message);
            statusMessage.textContent = data.message || "Simulation finished.";
            startSimButton.disabled = false;
            finishSimButton.disabled = true;
        });

        socket.on('simulation_error', (data) => {
            console.error('Backend: Simulation error:', data.error);
            errorMessage.textContent = `Error: ${data.agent ? data.agent + ': ' : ''}${data.error}`;
            statusMessage.textContent = "Simulation encountered an error.";
            startSimButton.disabled = false; // Allow retrying
            finishSimButton.disabled = true;
        });

        socket.on('disconnect', (reason) => {
            console.log("Socket disconnected:", reason);
            statusMessage.textContent = "Disconnected from server. Check console.";
            // startSimButton.disabled = true; // Or attempt auto-reconnect
            finishSimButton.disabled = true;
        });


        // Event Listeners
        addMealButton.addEventListener('click', addMealEntry);
        startSimButton.addEventListener('click', startContinuousSimulation);
        finishSimButton.addEventListener('click', finishContinuousSimulation);

        // Initial setup
        window.onload = () => {
            initializeChart();
            addMealEntry(); 
        };
    </script>
</body>
</html>